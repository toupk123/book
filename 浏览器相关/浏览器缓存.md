# 浏览器缓存

浏览器缓存本质是为了减少请求，就地复用本地的资源，浏览器缓存分为三种：

1. 强缓存
2. 协商缓存
3. 缓存位置

## 强缓存

在没到设置的时间之前，都会一直服用本地缓存，而不去发起请求。

在http1.0 中是通过Expires设置，在http1.1 版本中使用Cache-Control.

### Expires的问题

因为后台服务器会返回可以缓存的时间 Expires : wed,22 Nov 2019 08:41:00

但是问题是`服务器时间和浏览器时间不一定相同`。

### Cache-Contorl

基于上面存在的问题，所以在1.1版本中，有效期变成以秒计算。

```js
Cache-Control:max-age=3600
```

一个小时之内都可以使用缓存，超过这个时间就得向后端发起请求

一些其他Cache-Control的值

```js
private 只能浏览器能缓存
no-cache 跳过当前强缓存，发送http请求，直接进入协商缓存阶段
no-store：不使用任何缓存
s-maxage：代理服务器使用的缓存时间

```

**Cache-Control**优先级高于**Expires**，当强缓存时间超时，会进入协商缓存

## 协商缓存

强缓存失效之后，浏览器会在请求头中携带响应的`缓存Tag`来向服务器发起请求，由服务器来决定是否使用缓存。

tag分为两种

1. Last-Modified
2. ETag

### Last-Modified

浏览器第一次发送请求后，服务器会响应头中加上字段，浏览器接受到后，如果再次去请求这个资源，会在请求头上携带`If-Modified-Since` 字段，这个字段的值就是服务器传来的最后修改时间。

服务器拿到这个字段后，会和资源最后修改时间做对比，

1. 如果请求头中时间小于最后修改时间，说明资源更新了，返回新资源。
2. 否则返回304，告诉浏览器直接使用缓存。

### ETag

ETag是服务器根据当前文件内容，生成的一种唯一标识，只要里面内容变动，这个值也就会变。

服务器通过响应头会将这个值返回给浏览器。

浏览器收到这个值之后，会在下次请求通过`If-None-Match`这个字段内容，并放到请求头中，发送给服务器。

1. 不相同就是走资源更新
2. 相同，直接告诉浏览器直接用缓存。

#### 两者对比

1. 在`精准度`上，`ETag`优于`Last-Modified`。优于 ETag 是按照内容给资源上标识，因此能准确感知资源的变化。而 Last-Modified 就不一样了，它在一些特殊的情况并不能准确感知资源变化，主要有两种情况:

- 编辑了资源文件，但是文件内容并没有更改，这样也会造成缓存失效。
- Last-Modified 能够感知的单位时间是秒，如果文件在 1 秒内改变了多次，那么这时候的 Last-Modified 并没有体现出修改了。

1. 在性能上，`Last-Modified`优于`ETag`，也很简单理解，`Last-Modified`仅仅只是记录一个时间点，而 `Etag`需要根据文件的具体内容生成哈希值。

另外，如果两种方式都支持的话，服务器会优先考虑`ETag`。

## 缓存位置

在服务器返回304的时候，从缓存中直接获取资源，这些资源缓存在下列四种,优先级从高到低

- Service Worker
- Memory Cache
- Disk Cache
- Push Cache

### Service Worker

借鉴于web worker

### Memory Cache 和 Disk Cache

**Memory Cache**指的是内存缓存，从效率上讲它是最快的。但是从存活时间来讲又是最短的，当渲染进程结束后，内存缓存也就不存在了。

**Disk Cache**就是存储在磁盘中的缓存，从存取效率上讲是比内存缓存慢的，但是他的优势在于存储容量和存储时长。稍微有些计算机基础的应该很好理解，就不展开了。

好，现在问题来了，既然两者各有优劣，那浏览器如何决定将资源放进内存还是硬盘呢？主要策略如下：

- 比较大的JS、CSS文件会直接被丢进磁盘，反之丢进内存
- 内存使用率比较高的时候，文件优先进入磁盘

## 总结

对浏览器的缓存机制来做个简要的总结:

首先通过 `Cache-Control` 验证强缓存是否可用

- 如果强缓存可用，直接使用

- 否则进入协商缓存，即发送 HTTP 请求，服务器通过请求头中的

  ```
  If-Modified-Since
  ```

  或者

  ```
  If-None-Match
  ```

  字段检查资源是否更新

  - 若资源更新，返回资源和200状态码
  - 否则，返回304，告诉浏览器直接从缓存获取资源









